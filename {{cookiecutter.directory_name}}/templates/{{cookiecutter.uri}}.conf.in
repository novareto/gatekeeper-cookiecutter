WSGIPythonHome "${buildout:directory}"

LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %D %>D BGHW" combined_ls
<IfModule mod_ssl.c>

<VirtualHost ${config:conf-global-ip}:443>
  ServerAdmin ${config:conf-global-admin} 
  ServerName ${config:conf-global-uri} 
  LogLevel debug ssl:info
  ErrorLog  /var/log/apache2/${config:conf-global-uri}_error.log
  CustomLog /var/log/apache2/${config:conf-global-uri}_access.log combined_ls

  SSLEngine on
  SSLCertificateFile /etc/apache2/cert/kuvb.de.crt
  SSLCACertificateFile /etc/apache2/cert/kuvb.de-ca.crt
  SSLCertificateKeyFile /etc/apache2/cert/kuvb.de.key

  TKTAuthPublicKey ${buildout:directory}/etc/pubkey.pem
  WSGIDaemonProcess gatekeeper user=${config:conf-global-user_gruppe} group=${config:conf-global-user_gruppe} threads=1 home=${buildout:directory}
  WSGIProcessGroup gatekeeper

  <Directory "${buildout:directory}">
    WSGIProcessGroup gatekeeper
    WSGIApplicationGroup %{GLOBAL}
    Require all granted
  </Directory>

  <Location "/static/">
    Options -Indexes
  </Location>
  
  Alias /static/ ${buildout:directory}/keeper/static/
  WSGIScriptAlias /login ${buildout:directory}/app.py
  
  <Proxy http://HOST_PORT/*>
    AuthType mod_auth_pubtkt
    TKTAuthLoginURL   https://${config:conf-global-uri}/login
    TKTAuthTimeoutURL https://${config:conf-global-uri}/?timeout=1
    TKTAuthUnauthURL  https://${config:conf-global-uri}/?unauth=1
    TKTAuthDebug 0
    TKTAuthFakeBasicAuth on
    TKTAuthPassthruBasicAuth on
    TKTAuthPassthruBasicKey ${config:conf-crypto-cipher}
    require valid-user
  </Proxy>

  RewriteEngine on
  RewriteCond %{REQUEST_URI} !^/login*
  RewriteCond %{REQUEST_URI} !^/static/*
  # GROK
  # RewriteRule ^(/?.*) http://HOST_PORT/portal/++vh++https:${config:conf-global-uri}:443/++$1 [P]
  # PLONE
  # RewriteRule ^(/?.*) http://HOST_PORT/VirtualHostBase/https/${config:conf-global-uri}:443/vergabe/VirtualHostRoot/$1 [P]

</VirtualHost>
</IfModule>